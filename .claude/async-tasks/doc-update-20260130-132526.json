{
  "type": "doc-update",
  "created_at": "2026-01-30T13:25:26.077852+00:00",
  "status": "pending",
  "commit_message": "feat(hooks): add PID-scoped state files for multi-agent isolation\n\nMultiple Claude Code agents running in parallel in the same repo\ncollided on shared state files (.claude/forge-state.json, etc.).\nContext compaction also caused state file cleanup when session IDs\nchanged despite the same process still running.\n\nPID-scoped filenames (e.g., forge-state.12345.json) solve both:\n- Unique per agent (OS PID guarantee)\n- Stable across compaction (same process)\n- Self-cleaning via is_pid_alive() check\n\nChanges:\n- _common.py: Add get_session_pid(), _scoped_filename(), PID helpers;\n  update all state file lookups with PID-scoped \u2192 legacy fallback\n- session-snapshot.py: PID-scoped snapshot + dead-PID cleanup\n- skill-state-initializer.py: PID-scoped state creation\n- lite-heavy-tracker.py: Use _find_state_file_path() for state lookup\n- stop-validator.py: PID-scoped snapshot lookup\n- plan-mode-tracker.py: Fix repair\u2192appfix filename mapping bug\n- .gitignore: Add PID-scoped patterns\n- Tests: Update for PID-scoped files, godo\u2192forge, code_changes_made\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>",
  "diff_content": "commit 8b96cb399128ce8196649996aff7311d331dbe92\nAuthor: olivier-motium <243932812+olivier-motium@users.noreply.github.com>\nDate:   Fri Jan 30 14:25:25 2026 +0100\n\n    feat(hooks): add PID-scoped state files for multi-agent isolation\n    \n    Multiple Claude Code agents running in parallel in the same repo\n    collided on shared state files (.claude/forge-state.json, etc.).\n    Context compaction also caused state file cleanup when session IDs\n    changed despite the same process still running.\n    \n    PID-scoped filenames (e.g., forge-state.12345.json) solve both:\n    - Unique per agent (OS PID guarantee)\n    - Stable across compaction (same process)\n    - Self-cleaning via is_pid_alive() check\n    \n    Changes:\n    - _common.py: Add get_session_pid(), _scoped_filename(), PID helpers;\n      update all state file lookups with PID-scoped \u2192 legacy fallback\n    - session-snapshot.py: PID-scoped snapshot + dead-PID cleanup\n    - skill-state-initializer.py: PID-scoped state creation\n    - lite-heavy-tracker.py: Use _find_state_file_path() for state lookup\n    - stop-validator.py: PID-scoped snapshot lookup\n    - plan-mode-tracker.py: Fix repair\u2192appfix filename mapping bug\n    - .gitignore: Add PID-scoped patterns\n    - Tests: Update for PID-scoped files, godo\u2192forge, code_changes_made\n    \n    Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>\n---\n .gitignore                                 |  21 +-\n config/hooks/_common.py                    | 333 +++++++++++++++++++++++++----\n config/hooks/lite-heavy-tracker.py         |  34 ++-\n config/hooks/plan-mode-tracker.py          |   8 +-\n config/hooks/session-snapshot.py           |  25 ++-\n config/hooks/skill-state-initializer.py    |   9 +-\n config/hooks/stop-validator.py             |   6 +-\n config/hooks/tests/test_plan_mode_hooks.py |  90 +++++---\n config/hooks/tests/test_sticky_session.py  |  65 +++---\n config/hooks/tests/test_sv_validators.py   |  14 +-\n 10 files changed, 473 insertions(+), 132 deletions(-)\n\ndiff --git a/.gitignore b/.gitignore\nindex 1842304..ec78fb1 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -4,22 +4,41 @@ __pycache__/\n *$py.class\n \n # Claude Code session state (transient files)\n-# Root level .claude/\n+# Root level .claude/ \u2014 legacy unscoped files\n .claude/completion-checkpoint.json\n .claude/session-snapshot.json\n .claude/appfix-state.json\n+.claude/forge-state.json\n+.claude/burndown-state.json\n .claude/godo-state.json\n+.claude/session-owner.json\n .claude/web-smoke/\n .claude/compacted.*.marker\n .claude/validation-tests/\n .claude/toolkit-update-state.json\n \n+# PID-scoped session state files (e.g., forge-state.12345.json)\n+.claude/forge-state.*.json\n+.claude/appfix-state.*.json\n+.claude/burndown-state.*.json\n+.claude/completion-checkpoint.*.json\n+.claude/session-snapshot.*.json\n+\n # Nested .claude/ directories (e.g., config/hooks/.claude/)\n **/.claude/completion-checkpoint.json\n **/.claude/session-snapshot.json\n **/.claude/appfix-state.json\n+**/.claude/forge-state.json\n+**/.claude/burndown-state.json\n **/.claude/godo-state.json\n+**/.claude/session-owner.json\n **/.claude/web-smoke/\n+# Nested PID-scoped files\n+**/.claude/forge-state.*.json\n+**/.claude/appfix-state.*.json\n+**/.claude/burndown-state.*.json\n+**/.claude/completion-checkpoint.*.json\n+**/.claude/session-snapshot.*.json\n \n # OS\n .DS_Store\ndiff --git a/config/hooks/_common.py b/config/hooks/_common.py\nindex 4256a8f..1bcf339 100755\n--- a/config/hooks/_common.py\n+++ b/config/hooks/_common.py\n@@ -67,6 +67,99 @@ VERSION_TRACKING_EXCLUSIONS = [\n DEBUG_LOG = Path(tempfile.gettempdir()) / \"claude-hooks-debug.log\"\n \n \n+# ============================================================================\n+# PID-Based Session Scoping\n+# ============================================================================\n+\n+\n+def get_session_pid() -> int:\n+    \"\"\"Get the Claude Code ancestor PID for this session.\n+\n+    PID is the key for session-scoped state files because it:\n+    - Is unique across parallel Claude agents (OS guarantee)\n+    - Persists through context compaction (same process)\n+    - Is discoverable from any hook via process tree walking\n+\n+    Returns:\n+        Claude Code process PID\n+    \"\"\"\n+    return _get_ancestor_pid()\n+\n+\n+def _scoped_filename(filename: str, pid: int | None = None) -> str:\n+    \"\"\"Convert a state filename to its PID-scoped version.\n+\n+    Examples:\n+        'forge-state.json' \u2192 'forge-state.12345.json'\n+        'completion-checkpoint.json' \u2192 'completion-checkpoint.12345.json'\n+\n+    Args:\n+        filename: Original filename (e.g., 'forge-state.json')\n+        pid: PID to scope to (default: current session PID)\n+\n+    Returns:\n+        PID-scoped filename\n+    \"\"\"\n+    if pid is None:\n+        pid = get_session_pid()\n+    base, ext = os.path.splitext(filename)\n+    return f\"{base}.{pid}{ext}\"\n+\n+\n+def _extract_pid_from_filename(filename: str) -> int | None:\n+    \"\"\"Extract PID from a PID-scoped filename.\n+\n+    Examples:\n+        'forge-state.12345.json' \u2192 12345\n+        'forge-state.json' \u2192 None (legacy, no PID)\n+\n+    Args:\n+        filename: Filename (stem or full name)\n+\n+    Returns:\n+        PID if found, None otherwise\n+    \"\"\"\n+    stem = Path(filename).stem\n+    parts = stem.rsplit(\".\", 1)\n+    if len(parts) == 2:\n+        try:\n+            return int(parts[1])\n+        except ValueError:\n+            return None\n+    return None\n+\n+\n+def _find_any_scoped_state_files(cwd: str, base_name: str) -> list[Path]:\n+    \"\"\"Find all PID-scoped state files matching a base name pattern.\n+\n+    Used for session-agnostic checks (e.g., \"is ANY forge session active?\").\n+\n+    Args:\n+        cwd: Directory containing .claude/\n+        base_name: Base name without extension (e.g., 'forge-state')\n+\n+    Returns:\n+        List of matching Path objects, sorted by modification time (newest first)\n+    \"\"\"\n+    results = []\n+    if not cwd:\n+        return results\n+\n+    claude_dir = Path(cwd) / \".claude\"\n+    if not claude_dir.exists():\n+        return results\n+\n+    # Match pattern: {base_name}.{digits}.json\n+    for f in claude_dir.glob(f\"{base_name}.*.json\"):\n+        pid = _extract_pid_from_filename(f.name)\n+        if pid is not None:\n+            results.append(f)\n+\n+    # Sort by modification time, newest first\n+    results.sort(key=lambda p: p.stat().st_mtime, reverse=True)\n+    return results\n+\n+\n def get_diff_hash(cwd: str = \"\") -> str:\n     \"\"\"\n     Get hash of current git diff (excluding metadata files).\n@@ -188,6 +281,9 @@ def _check_state_file(cwd: str, filename: str) -> bool:\n     Walks up the directory tree to find the state file,\n     similar to how git finds the .git directory.\n \n+    Checks PID-scoped filename first, then falls back to legacy unscoped name.\n+    Also checks for ANY PID-scoped file matching the base name (for multi-agent).\n+\n     IMPORTANT: Stops at the home directory to avoid picking up unrelated\n     state files from ~/.claude/ which is meant for global config, not\n     project-specific state.\n@@ -202,14 +298,25 @@ def _check_state_file(cwd: str, filename: str) -> bool:\n     if cwd:\n         current = Path(cwd).resolve()\n         home = Path.home()\n+        base_name = Path(filename).stem  # e.g., 'forge-state'\n         # Walk up to home directory (max 20 levels to prevent infinite loops)\n         for _ in range(20):\n             # Stop at home directory - ~/.claude/ is for global config, not project state\n             if current == home:\n                 break\n-            state_file = current / \".claude\" / filename\n-            if state_file.exists():\n-                return True\n+            claude_dir = current / \".claude\"\n+            if claude_dir.exists():\n+                # 1. Check PID-scoped file for this session\n+                scoped = claude_dir / _scoped_filename(filename)\n+                if scoped.exists():\n+                    return True\n+                # 2. Check any PID-scoped file (another active agent)\n+                if _find_any_scoped_state_files(str(curre\n\n... [truncated - diff too long]",
  "existing_docs": [
    "docs/architecture.md",
    "docs/index.md",
    "docs/philosophy.md",
    "README.md",
    ".claude/MEMORIES.md"
  ],
  "instructions": "\nDOCUMENTATION UPDATE TASK\n\nA commit was just made in an appfix/godo session. Your job is to:\n\n1. Analyze the diff to understand what changed\n2. Determine which documentation files need updating\n3. Update the relevant docs to reflect the changes\n\nCOMMIT MESSAGE:\nfeat(hooks): add PID-scoped state files for multi-agent isolation\n\nMultiple Claude Code agents running in parallel in the same repo\ncollided on shared state files (.claude/forge-state.json, etc.).\nContext compaction also caused state file cleanup when session IDs\nchanged despite the same process still running.\n\nPID-scoped filenames (e.g., forge-state.12345.json) solve both:\n- Unique per agent (OS PID guarantee)\n- Stable across compaction (same process)\n- Self-cleaning via is_pid_alive() check\n\nChanges:\n- _common.py: Add get_session_pid(), _scoped_filename(), PID helpers;\n  update all state file lookups with PID-scoped \u2192 legacy fallback\n- session-snapshot.py: PID-scoped snapshot + dead-PID cleanup\n- skill-state-initializer.py: PID-scoped state creation\n- lite-heavy-tracker.py: Use _find_state_file_path() for state lookup\n- stop-validator.py: PID-scoped snapshot lookup\n- plan-mode-tracker.py: Fix repair\u2192appfix filename mapping bug\n- .gitignore: Add PID-scoped patterns\n- Tests: Update for PID-scoped files, godo\u2192forge, code_changes_made\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>\n\nEXISTING DOCUMENTATION FILES:\n- docs/architecture.md\n- docs/index.md\n- docs/philosophy.md\n- README.md\n- .claude/MEMORIES.md\n\nDIFF CONTENT:\ncommit 8b96cb399128ce8196649996aff7311d331dbe92\nAuthor: olivier-motium <243932812+olivier-motium@users.noreply.github.com>\nDate:   Fri Jan 30 14:25:25 2026 +0100\n\n    feat(hooks): add PID-scoped state files for multi-agent isolation\n    \n    Multiple Claude Code agents running in parallel in the same repo\n    collided on shared state files (.claude/forge-state.json, etc.).\n    Context compaction also caused state file cleanup when session IDs\n    changed despite the same process still running.\n    \n    PID-scoped filenames (e.g., forge-state.12345.json) solve both:\n    - Unique per agent (OS PID guarantee)\n    - Stable across compaction (same process)\n    - Self-cleaning via is_pid_alive() check\n    \n    Changes:\n    - _common.py: Add get_session_pid(), _scoped_filename(), PID helpers;\n      update all state file lookups with PID-scoped \u2192 legacy fallback\n    - session-snapshot.py: PID-scoped snapshot + dead-PID cleanup\n    - skill-state-initializer.py: PID-scoped state creation\n    - lite-heavy-tracker.py: Use _find_state_file_path() for state lookup\n    - stop-validator.py: PID-scoped snapshot lookup\n    - plan-mode-tracker.py: Fix repair\u2192appfix filename mapping bug\n    - .gitignore: Add PID-scoped patterns\n    - Tests: Update for PID-scoped files, godo\u2192forge, code_changes_made\n    \n    Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>\n---\n .gitignore                                 |  21 +-\n config/hooks/_common.py                    | 333 +++++++++++++++++++++++++----\n config/hooks/lite-heavy-tracker.py         |  34 ++-\n config/hooks/plan-mode-tracker.py          |   8 +-\n config/hooks/session-snapshot.py           |  25 ++-\n config/hooks/skill-state-initializer.py    |   9 +-\n config/hooks/stop-validator.py             |   6 +-\n config/hooks/tests/test_plan_mode_hooks.py |  90 +++++---\n config/hooks/tests/test_sticky_session.py  |  65 +++---\n config/hooks/tests/test_sv_validators.py   |  14 +-\n 10 files changed, 473 insertions(+), 132 deletions(-)\n\ndiff --git a/.gitignore b/.gitignore\nindex 1842304..ec78fb1 100644\n--- a/.gitignore\n+++ b/.gitignore\n@@ -4,22 +4,41 @@ __pycache__/\n *$py.class\n \n # Claude Code session state (transient files)\n-# Root level .claude/\n+# Root level .claude/ \u2014 legacy unscoped files\n .claude/completion-checkpoint.json\n .claude/session-snapshot.json\n .claude/appfix-state.json\n+.claude/forge-state.json\n+.claude/burndown-state.json\n .claude/godo-state.json\n+.claude/session-owner.json\n .claude/web-smoke/\n .claude/compacted.*.marker\n .claude/validation-tests/\n .claude/toolkit-update-state.json\n \n+# PID-scoped session state files (e.g., forge-state.12345.json)\n+.claude/forge-state.*.json\n+.claude/appfix-state.*.json\n+.claude/burndown-state.*.json\n+.claude/completion-checkpoint.*.json\n+.claude/session-snapshot.*.json\n+\n # Nested .claude/ directories (e.g., config/hooks/.claude/)\n **/.claude/completion-checkpoint.json\n **/.claude/session-snapshot.json\n **/.claude/appfix-state.json\n+**/.claude/forge-state.json\n+**/.claude/burndown-state.json\n **/.claude/godo-state.json\n+**/.claude/session-owner.json\n **/.claude/web-smoke/\n+# Nested PID-scoped files\n+**/.claude/forge-state.*.json\n+**/.claude/appfix-state.*.json\n+**/.claude/burndown-state.*.json\n+**/.claude/completion-checkpoint.*.json\n+**/.claude/session-snapshot.*.json\n \n # OS\n .DS_Store\ndiff --git a/config/hooks/_common.py b/config/hooks/_common.py\nindex 4256a8f..1bcf339 100755\n--- a/config/hooks/_common.py\n+++ b/config/hooks/_common.py\n@@ -67,6 +67,99 @@ VERSION_TRACKING_EXCLUSIONS = [\n DEBUG_LOG = Path(tempfile.gettempdir()) / \"claude-hooks-debug.log\"\n \n \n+# ============================================================================\n+# PID-Based Session Scoping\n+# ============================================================================\n+\n+\n+def get_session_pid() -> int:\n+    \"\"\"Get the Claude Code ancestor PID for this session.\n+\n+    PID is the key for session-scoped state files because it:\n+    - Is unique across parallel Claude agents (OS guarantee)\n+    - Persists through context compaction (same process)\n+    - Is discoverable from any hook via process tree walking\n+\n+    Returns:\n+        Claude Code process PID\n+    \"\"\"\n+    return _get_ancestor_pid()\n+\n+\n+def _scoped_filename(filename: str, pid: int | None = None) -> str:\n+    \"\"\"Convert a state filename to its PID-scoped version.\n+\n+    Examples:\n+        'forge-state.json' \u2192 'forge-state.12345.json'\n+        'completion-checkpoint.json' \u2192 'completion-checkpoint.12345.json'\n+\n+    Args:\n+        filename: Original filename (e.g., 'forge-state.json')\n+        pid: PID to scope to (default: current session PID)\n+\n+    Returns:\n+        PID-scoped filename\n+    \"\"\"\n+    if pid is None:\n+        pid = get_session_pid()\n+    base, ext = os.path.splitext(filename)\n+    return f\"{base}.{pid}{ext}\"\n+\n+\n+def _extract_pid_from_filename(filename: str) -> int | None:\n+    \"\"\"Extract PID from a PID-scoped filename.\n+\n+    Examples:\n+        'forge-state.12345.json' \u2192 12345\n+        'forge-state.json' \u2192 None (legacy, no PID)\n+\n+    Args:\n+        filename: Filename (stem or full name)\n+\n+    Returns:\n+        PID if found, None otherwise\n+    \"\"\"\n+    stem = Path(filename).stem\n+    parts = stem.rsplit(\".\", 1)\n+    if len(parts) == 2:\n+        try:\n+            return int(parts[1])\n+        except ValueError:\n+            return None\n+    return None\n+\n+\n+def _find_any_scoped_state_files(cwd: str, base_name: str) -> list[Path]:\n+    \"\"\"Find all PID-scoped state files matching a base name pattern.\n+\n+    Used for session-agnostic checks (e.g., \"is ANY forge session active?\").\n+\n+    Args:\n+        cwd: Directory containing .claude/\n+        base_name: Base name without extension (e.g., 'forge-state')\n+\n+    Returns:\n+        List of matching Path objects, sorted by modification time (newest first)\n+    \"\"\"\n+    results = []\n+    if not cwd:\n+        return results\n+\n+    claude_dir = Path(cwd) / \".claude\"\n+    if not claude_dir.exists():\n+        return results\n+\n+    # Match pattern: {base_name}.{digits}.json\n+    for f in claude_dir.glob(f\"{base_name}.*.json\"):\n+        pid = _extract_pid_from_filename(f.name)\n+        if pid is not None:\n+            results.append(f)\n+\n+    # Sort by modification time, newest first\n+    results.sort(key=lambda p: p.stat().st_mtime, reverse=True)\n+    return results\n+\n+\n def get_diff_hash(cwd: str = \"\") -> str:\n     \"\"\"\n     Get hash of current git diff (excluding metadata files).\n@@ -188,6 +281,9 @@ def _check_state_file(cwd: str, filename: str) -> bool:\n     Walks up the directory tree to find the state file,\n     similar to how git finds the .git directory.\n \n+    Checks PID-scoped filename first, then falls back to legacy unscoped name.\n+    Also checks for ANY PID-scoped file matching the base name (for multi-agent).\n+\n     IMPORTANT: Stops at the home directory to avoid picking up unrelated\n     state files from ~/.claude/ which is meant for global config, not\n     project-specific state.\n@@ -202,14 +298,25 @@ def _check_state_file(cwd: str, filename: str) -> bool:\n     if cwd:\n         current = Path(cwd).resolve()\n         home = Path.home()\n+        base_name = Path(filename).stem  # e.g., 'forge-state'\n         # Walk up to home directory (max 20 levels to prevent infinite loops)\n         for _ in range(20):\n             # Stop at home directory - ~/.claude/ is for global config, not project state\n             if current == home:\n                 break\n-            state_file = current / \".claude\" / filename\n-            if state_file.exists():\n-                return True\n+            claude_dir = current / \".claude\"\n+            if claude_dir.exists():\n+                # 1. Check PID-scoped file for this session\n+                scoped = claude_dir / _scoped_filename(filename)\n+                if scoped.exists():\n+                    return True\n+                # 2. Check any PID-scoped file (another active agent)\n+                if _find_any_scoped_state_files(str(curre\n\n... [truncated - diff too long]\n\nINSTRUCTIONS:\n- Only update docs that are actually affected by this change\n- Keep updates concise and accurate\n- Don't add unnecessary documentation\n- If the change is purely code (no architectural/API changes), you may skip doc updates\n- Focus on: API changes, new features, architectural decisions, configuration changes\n\nUse the /heavy skill if you need multiple perspectives on what to document.\n"
}